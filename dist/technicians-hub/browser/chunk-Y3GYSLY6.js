import{e as m}from"./chunk-7YQTHMTJ.js";import{a as s,aa as I,b as l,ea as S,i as u}from"./chunk-WBOJ7OJP.js";var v=class d{locationsSubject=new u([]);locations$=this.locationsSubject.asObservable();constructor(){this.initSeedData()}initSeedData(){let e=[{id:"LOC-WH-001",name:"Main Warehouse - Sunny Site",type:"WAREHOUSE",siteId:"SITE-001",address:"100 Industrial Blvd",active:!0},{id:"LOC-WH-002",name:"Secondary Warehouse",type:"WAREHOUSE",siteId:"SITE-001",address:"200 Storage Ave",active:!0},{id:"LOC-TRUCK-001",name:"Truck - TECH-01",type:"TRUCK",technicianId:"TECH-01",siteId:"SITE-001",active:!0},{id:"LOC-TRUCK-002",name:"Truck - TECH-02",type:"TRUCK",technicianId:"TECH-02",siteId:"SITE-001",active:!0},{id:"LOC-TRUCK-003",name:"Truck - TECH-03",type:"TRUCK",technicianId:"TECH-03",siteId:"SITE-001",active:!0}];this.locationsSubject.next(e)}getAll(){return this.locationsSubject.value}getById(e){return this.locationsSubject.value.find(t=>t.id===e)}getByType(e){return this.locationsSubject.value.filter(t=>t.type===e)}getWarehouses(){return this.getByType("WAREHOUSE")}getTrucks(){return this.getByType("TRUCK")}getTruckForTechnician(e){return this.locationsSubject.value.find(t=>t.type==="TRUCK"&&t.technicianId===e)}getWarehousesForSite(e){return this.locationsSubject.value.filter(t=>t.type==="WAREHOUSE"&&t.siteId===e)}getTrucksForSite(e){return this.locationsSubject.value.filter(t=>t.type==="TRUCK"&&t.siteId===e)}create(e){let t=l(s({},e),{id:"LOC-"+Math.random().toString(36).substr(2,6).toUpperCase()}),i=this.locationsSubject.value;return this.locationsSubject.next([...i,t]),t}update(e,t){let i=this.locationsSubject.value,a=i.findIndex(r=>r.id===e);if(a!==-1)return i[a]=s(s({},i[a]),t),this.locationsSubject.next([...i]),i[a]}static \u0275fac=function(t){return new(t||d)};static \u0275prov=I({token:d,factory:d.\u0275fac,providedIn:"root"})};var p={id:"USER-001",name:"Admin"},b=class d{constructor(e,t){this.itemService=e;this.locationService=t;this.initSeedBalances()}balancesSubject=new u([]);balances$=this.balancesSubject.asObservable();transactionsSubject=new u([]);transactions$=this.transactionsSubject.asObservable();initSeedBalances(){let e=new Date().toISOString(),t=this.itemService.getAll(),i=this.locationService.getAll(),a=[],r=i.find(o=>o.id==="LOC-WH-001");r&&t.forEach(o=>{a.push({locationId:r.id,itemId:o.id,onHand:50+Math.floor(Math.random()*50),reserved:0,available:0,updatedAt:e})});let n=i.find(o=>o.id==="LOC-TRUCK-001");n&&a.push({locationId:n.id,itemId:"ITEM-001",onHand:5,reserved:0,available:0,updatedAt:e},{locationId:n.id,itemId:"ITEM-002",onHand:3,reserved:0,available:0,updatedAt:e},{locationId:n.id,itemId:"ITEM-004",onHand:10,reserved:0,available:0,updatedAt:e},{locationId:n.id,itemId:"ITEM-006",onHand:2,reserved:0,available:0,updatedAt:e});let c=i.find(o=>o.id==="LOC-TRUCK-002");c&&a.push({locationId:c.id,itemId:"ITEM-001",onHand:3,reserved:0,available:0,updatedAt:e},{locationId:c.id,itemId:"ITEM-005",onHand:2,reserved:0,available:0,updatedAt:e},{locationId:c.id,itemId:"ITEM-007",onHand:4,reserved:0,available:0,updatedAt:e}),a.forEach(o=>o.available=o.onHand-o.reserved),this.balancesSubject.next(a)}generateId(){return Math.random().toString(36).substr(2,9)}getBalance(e,t){return this.balancesSubject.value.find(i=>i.locationId===e&&i.itemId===t)}getBalancesForLocation(e){return this.balancesSubject.value.filter(t=>t.locationId===e)}getBalancesForItem(e){return this.balancesSubject.value.filter(t=>t.itemId===e)}ensureBalance(e,t){let i=this.getBalance(e,t);return i||(i={locationId:e,itemId:t,onHand:0,reserved:0,available:0,updatedAt:new Date().toISOString()},this.balancesSubject.next([...this.balancesSubject.value,i])),i}updateBalance(e,t,i){let a=this.balancesSubject.value,r=a.findIndex(n=>n.locationId===e&&n.itemId===t);if(r>=0){let n=l(s(s({},a[r]),i),{updatedAt:new Date().toISOString()});n.available=n.onHand-n.reserved,a[r]=n,this.balancesSubject.next([...a])}}postTransaction(e){let t=l(s({},e),{id:"TXN-"+this.generateId(),createdAt:new Date().toISOString(),createdBy:p});switch(e.type){case"RECEIVE":if(e.toLocationId){this.ensureBalance(e.toLocationId,e.itemId);let a=this.getBalance(e.toLocationId,e.itemId);this.updateBalance(e.toLocationId,e.itemId,{onHand:a.onHand+e.qty})}break;case"TRANSFER_OUT":if(e.fromLocationId){let a=this.getBalance(e.fromLocationId,e.itemId);a&&this.updateBalance(e.fromLocationId,e.itemId,{onHand:a.onHand-e.qty})}break;case"TRANSFER_IN":if(e.toLocationId){this.ensureBalance(e.toLocationId,e.itemId);let a=this.getBalance(e.toLocationId,e.itemId);this.updateBalance(e.toLocationId,e.itemId,{onHand:a.onHand+e.qty})}break;case"ISSUE_TO_ORDER":if(e.fromLocationId){let a=this.getBalance(e.fromLocationId,e.itemId);a&&this.updateBalance(e.fromLocationId,e.itemId,{onHand:a.onHand-e.qty,reserved:Math.max(0,a.reserved-e.qty)})}break;case"RETURN_FROM_ORDER":if(e.toLocationId){this.ensureBalance(e.toLocationId,e.itemId);let a=this.getBalance(e.toLocationId,e.itemId);this.updateBalance(e.toLocationId,e.itemId,{onHand:a.onHand+e.qty})}break;case"ADJUST":if(e.fromLocationId){let a=this.getBalance(e.fromLocationId,e.itemId);a&&this.updateBalance(e.fromLocationId,e.itemId,{onHand:a.onHand+e.qty})}break}let i=this.transactionsSubject.value;return this.transactionsSubject.next([...i,t]),t}reserveStock(e,t,i){let a=this.getBalance(e,t);return!a||a.available<i?!1:(this.updateBalance(e,t,{reserved:a.reserved+i}),!0)}releaseReserved(e,t,i){let a=this.getBalance(e,t);return a?(this.updateBalance(e,t,{reserved:Math.max(0,a.reserved-i)}),!0):!1}adjustStock(e,t,i,a){this.ensureBalance(e,t),this.postTransaction({type:"ADJUST",itemId:t,qty:i,fromLocationId:e,reason:a})}getLowStockItems(){let e=[];return this.balancesSubject.value.forEach(t=>{let i=this.itemService.getById(t.itemId),a=this.locationService.getById(t.locationId);i&&a&&i.reorderPoint&&t.available<=i.reorderPoint&&e.push({item:i,location:a,balance:t})}),e}getTotalAvailable(e){return this.balancesSubject.value.filter(t=>t.itemId===e).reduce((t,i)=>t+i.available,0)}findBestLocation(e,t,i){let a=this.getBalancesForItem(e).filter(c=>c.available>=t);if(i){let c=a.find(o=>o.locationId===i);if(c)return this.locationService.getById(c.locationId)}let r=a.filter(c=>this.locationService.getById(c.locationId)?.type==="TRUCK");if(r.length>0)return this.locationService.getById(r[0].locationId);let n=a.filter(c=>this.locationService.getById(c.locationId)?.type==="WAREHOUSE");if(n.length>0)return this.locationService.getById(n[0].locationId)}static \u0275fac=function(t){return new(t||d)(S(m),S(v))};static \u0275prov=I({token:d,factory:d.\u0275fac,providedIn:"root"})};export{v as a,b};
