import{a as y}from"./chunk-NAJWCQTC.js";import{a as u,aa as f,b as d,ea as I,f as T,fa as p,i as g,u as h}from"./chunk-WBOJ7OJP.js";var v=class c{configService=p(y);tasksSubject=new g([]);tasks$=this.tasksSubject.asObservable();pendingTasks$=this.tasks$.pipe(h(t=>t.filter(e=>e.status==="PENDING")));inReviewTasks$=this.tasks$.pipe(h(t=>t.filter(e=>e.status==="IN_REVIEW")));overdueTasks$=this.tasks$.pipe(h(t=>{let e=new Date().toISOString();return t.filter(i=>(i.status==="PENDING"||i.status==="IN_REVIEW")&&i.dueAt<e)}));completedTasks$=this.tasks$.pipe(h(t=>t.filter(e=>e.status==="COMPLETED")));constructor(){setInterval(()=>this.overdueSweep(),6e4)}createForWorkOrder(t,e,i){let n=this.configService.getConfig().reviewSlaHours??24,s=new Date,a=new Date(s.getTime()+n*60*60*1e3),l={id:this.generateId(),workOrderId:t,technicianId:e,supervisorId:i,status:"PENDING",dueAt:a.toISOString(),createdAt:s.toISOString(),updatedAt:s.toISOString()},o=this.tasksSubject.value;return this.tasksSubject.next([...o,l]),l}assignSupervisor(t,e){let i=this.tasksSubject.value,r=i.findIndex(a=>a.id===t);if(r===-1)return null;let n=d(u({},i[r]),{supervisorId:e,updatedAt:new Date().toISOString()}),s=[...i];return s[r]=n,this.tasksSubject.next(s),n}startReview(t){return this.updateTaskStatus(t,"IN_REVIEW")}completeReview(t){return this.updateTaskStatus(t,"COMPLETED")}getByWorkOrder(t){return this.tasks$.pipe(h(e=>e.find(i=>i.workOrderId===t)))}getTasksForSupervisor(t,e){return this.tasks$.pipe(h(i=>{let r=i.filter(n=>n.supervisorId===t);if(e?.status&&(r=r.filter(n=>n.status===e.status)),e?.overdue){let n=new Date().toISOString();r=r.filter(s=>(s.status==="PENDING"||s.status==="IN_REVIEW")&&s.dueAt<n)}return r}))}overdueSweep(){let t=this.tasksSubject.value,e=new Date().toISOString(),i=!1,r=t.map(n=>(n.status==="PENDING"||n.status==="IN_REVIEW")&&n.dueAt<e?(i=!0,d(u({},n),{status:"EXPIRED",updatedAt:e})):n);i&&this.tasksSubject.next(r)}getTimeRemaining(t){let e=new Date().getTime();return new Date(t.dueAt).getTime()-e}isOverdue(t){return t.status==="COMPLETED"||t.status==="EXPIRED"?!1:new Date(t.dueAt)<new Date}updateTaskStatus(t,e){let i=this.tasksSubject.value,r=i.findIndex(a=>a.id===t);if(r===-1)return null;let n=d(u({},i[r]),{status:e,updatedAt:new Date().toISOString()}),s=[...i];return s[r]=n,this.tasksSubject.next(s),n}generateId(){return`RT-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static \u0275fac=function(e){return new(e||c)};static \u0275prov=f({token:c,factory:c.\u0275fac,providedIn:"root"})};var m=class c{notificationsSubject=new g([]);notifications$=this.notificationsSubject.asObservable();create(t,e,i,r){let n=u({id:this.generateId(),type:t,title:e,message:i,timestamp:new Date().toISOString(),read:!1},r),s=this.notificationsSubject.value;return this.notificationsSubject.next([n,...s]),n}markAsRead(t){let i=this.notificationsSubject.value.map(r=>r.id===t?d(u({},r),{read:!0}):r);this.notificationsSubject.next(i)}markAllAsRead(){let e=this.notificationsSubject.value.map(i=>d(u({},i),{read:!0}));this.notificationsSubject.next(e)}delete(t){let i=this.notificationsSubject.value.filter(r=>r.id!==t);this.notificationsSubject.next(i)}clearAll(){this.notificationsSubject.next([])}getUnreadCount(){return new T(t=>{this.notifications$.subscribe(e=>{let i=e.filter(r=>!r.read).length;t.next(i)})})}notifyReviewTaskCreated(t,e){this.create("info","New Review Task",`Review required for Work Order ${t}`,{actionUrl:"/reviews",actionLabel:"View Reviews"})}notifyReviewDueSoon(t,e){this.create("warning","Review Due Soon",`Review for WO ${t} due in ${e} hours`,{actionUrl:"/reviews",actionLabel:"Review Now"})}notifyReviewOverdue(t){this.create("error","Review Overdue",`Review for Work Order ${t} is overdue`,{actionUrl:"/reviews",actionLabel:"Review Now"})}notifyReviewSubmitted(t,e){this.create("success","Review Submitted",`Review for WO ${t} completed with outcome: ${e}`,{actionUrl:"/orders",actionLabel:"View Orders"})}notifyFollowUpCreated(t,e){this.create("warning","Follow-Up Order Created",`Follow-up order ${e} created for ${t}`,{actionUrl:"/orders",actionLabel:"View Order"})}generateId(){return`NOTIF-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static \u0275fac=function(e){return new(e||c)};static \u0275prov=f({token:c,factory:c.\u0275fac,providedIn:"root"})};var w=class c{getTechnicians(){let t=new Date().toISOString().split("T")[0];return[{id:"TECH-001",name:"Alice Johnson",active:!0,shiftStatus:"On",currentGeo:{lat:40.7128,lng:-74.006,ts:new Date().toISOString()},serviceRadiusKm:30,skills:["AC","Mechanical"],dailyCapacity:5,shift:{start:`${t}T08:00:00`,end:`${t}T17:00:00`},breaks:[{start:`${t}T12:00:00`,end:`${t}T12:30:00`}],startLocation:{lat:40.7128,lng:-74.006,name:"Office"}},{id:"TECH-002",name:"Bob Smith",active:!0,shiftStatus:"On",currentGeo:{lat:40.73,lng:-73.995,ts:new Date().toISOString()},serviceRadiusKm:20,skills:["Electrical"],dailyCapacity:4,shift:{start:`${t}T09:00:00`,end:`${t}T18:00:00`},breaks:[{start:`${t}T13:00:00`,end:`${t}T13:30:00`}],startLocation:{lat:40.73,lng:-73.995,name:"Home"}},{id:"TECH-003",name:"Charlie Davis",active:!0,shiftStatus:"Off",currentGeo:{lat:40.7589,lng:-73.9851,ts:new Date().toISOString()},serviceRadiusKm:25,skills:["AC","Electrical"],dailyCapacity:5,shift:{start:`${t}T08:00:00`,end:`${t}T16:00:00`},startLocation:{lat:40.7589,lng:-73.9851,name:"Depot"}}]}getWorkOrders(){let t=new Date,e=t.toISOString().split("T")[0];return[{id:"WO-1001",number:"WO-1001",siteId:"SITE-001",category:"AC",priority:"High",warranty:!0,status:"Ready",customer:{name:"John Doe",phone:"+1-555-0101",email:"john.doe@example.com",unit:"Apt 4B"},address:{line1:"123 Broadway",city:"New York",lat:40.713,lng:-74.005},createdAt:new Date(t.getTime()-1e3*60*60).toISOString(),notes:"AC unit making loud noise",serviceTimeMin:60,timeWindow:{start:`${e}T10:00:00`,end:`${e}T12:00:00`}},{id:"WO-1002",number:"WO-1002",siteId:"SITE-001",category:"Mechanical",priority:"Normal",warranty:!1,status:"New",customer:{name:"Jane Smith",phone:"+1-555-0202",email:"jane.smith@example.com"},address:{line1:"456 5th Ave",city:"New York",lat:40.7484,lng:-73.9857},createdAt:new Date(t.getTime()-1e3*60*30).toISOString(),serviceTimeMin:45},{id:"WO-1003",number:"WO-1003",siteId:"SITE-001",category:"Electrical",priority:"Urgent",warranty:!1,status:"Ready",customer:{name:"Mike Wilson",phone:"+1-555-0303"},address:{line1:"789 Park Ave",city:"New York",lat:40.7614,lng:-73.9776},createdAt:new Date(t.getTime()-1e3*60*15).toISOString(),serviceTimeMin:30,timeWindow:{start:`${e}T09:00:00`,end:`${e}T10:00:00`}},{id:"WO-1004",number:"WO-1004",siteId:"SITE-001",category:"AC",priority:"Low",warranty:!0,status:"New",customer:{name:"Sarah Brown",email:"sarah.b@example.com"},address:{line1:"321 Wall St",city:"New York",lat:40.7074,lng:-74.0113},createdAt:new Date(t.getTime()-1e3*60*45).toISOString(),serviceTimeMin:45}]}static \u0275fac=function(e){return new(e||c)};static \u0275prov=f({token:c,factory:c.\u0275fac,providedIn:"root"})};var S={id:"USER-001",name:"Admin",role:"Dispatcher"},R=class c{constructor(t){this.seedData=t;this.initializeData()}reviewTaskService=p(v);notificationService=p(m);techniciansSubject=new g([]);technicians$=this.techniciansSubject.asObservable();workOrdersSubject=new g([]);workOrders$=this.workOrdersSubject.asObservable();assignmentsSubject=new g([]);assignments$=this.assignmentsSubject.asObservable();initializeData(){this.techniciansSubject.next(this.seedData.getTechnicians());let t=this.seedData.getWorkOrders().map(e=>d(u({},e),{statusHistory:[],changeLog:[]}));this.workOrdersSubject.next(t)}getTechnicians(){return this.techniciansSubject.value}updateTechnician(t){let e=this.techniciansSubject.value,i=e.findIndex(r=>r.id===t.id);i>-1&&(e[i]=t,this.techniciansSubject.next([...e]))}getTechnician(t){return this.techniciansSubject.value.find(e=>e.id===t)}addWorkOrder(t){let e=d(u({},t),{statusHistory:t.statusHistory||[],changeLog:t.changeLog||[]});this.appendStatusInternal(e,{id:this.generateId(),workOrderId:t.id,fromStatus:null,toStatus:t.status,at:new Date().toISOString(),by:S});let i=this.workOrdersSubject.value;this.workOrdersSubject.next([...i,e])}updateWorkOrder(t){let e=this.workOrdersSubject.value,i=e.findIndex(r=>r.id===t.id);i>-1&&(e[i]=t,this.workOrdersSubject.next([...e]))}getWorkOrder(t){return this.workOrdersSubject.value.find(e=>e.id===t)}updateWorkOrderTracked(t,e,i,r){let n=this.workOrdersSubject.value,s=n.findIndex(o=>o.id===t);if(s===-1)return;let a=u({},n[s]),l=new Date().toISOString();for(let o of Object.keys(e)){if(o==="statusHistory"||o==="changeLog"||o==="result")continue;let b=a[o],O=e[o];if(b!==O){let j={id:this.generateId(),workOrderId:t,field:o,from:this.serializeValue(o,b),to:this.serializeValue(o,O),at:l,by:S,reason:i,note:r};a.changeLog=[...a.changeLog||[],j]}}if(e.status&&e.status!==a.status){let o={id:this.generateId(),workOrderId:t,fromStatus:a.status,toStatus:e.status,at:l,by:S,reason:i,note:r};a.statusHistory=[...a.statusHistory||[],o]}return Object.assign(a,e),n[s]=a,this.workOrdersSubject.next([...n]),a}appendStatus(t,e,i,r,n){let s=this.getWorkOrder(t);if(!s)return;let a={id:this.generateId(),workOrderId:t,fromStatus:e,toStatus:i,at:new Date().toISOString(),by:S,reason:r,note:n},l=d(u({},s),{status:i,statusHistory:[...s.statusHistory||[],a]});i==="Completed"&&e!=="Completed"&&(l.completedAt=a.at,this.triggerReviewWorkflow(l)),this.updateWorkOrder(l)}appendStatusInternal(t,e){t.statusHistory=[...t.statusHistory||[],e]}appendChange(t,e,i,r,n,s){let a=this.getWorkOrder(t);if(!a)return;let l={id:this.generateId(),workOrderId:t,field:e,from:i,to:r,at:new Date().toISOString(),by:S,reason:n,note:s},o=d(u({},a),{changeLog:[...a.changeLog||[],l]});this.updateWorkOrder(o)}updateResult(t,e){let i=this.getWorkOrder(t);if(!i)return;let r=d(u({},i),{result:e});this.appendChange(t,"result",i.result?"Previous result":null,`Resolution: ${e.resolutionCode}`),this.updateWorkOrder(r)}getLastUpdate(t){let e=this.getWorkOrder(t);if(!e)return null;let i=[];return e.statusHistory&&e.statusHistory.forEach(r=>i.push(r.at)),e.changeLog&&e.changeLog.forEach(r=>i.push(r.at)),i.length===0?null:(i.sort((r,n)=>new Date(n).getTime()-new Date(r).getTime()),new Date(i[0]))}addAssignment(t){let e=this.assignmentsSubject.value;this.assignmentsSubject.next([...e,t])}generateId(){return Math.random().toString(36).substr(2,9)}serializeValue(t,e){if(e==null)return"-";if(t==="assignedTechnicianId"&&e){let i=this.getTechnician(e);return i?i.name:e}return t==="scheduledStartAt"&&e?new Date(e).toLocaleString():typeof e=="object"?JSON.stringify(e):String(e)}triggerReviewWorkflow(t){if(!t.assignedTechnicianId)return;let e=this.reviewTaskService.createForWorkOrder(t.id,t.assignedTechnicianId);this.notificationService.notifyReviewTaskCreated(t.number,"Supervisor"),console.log(`Review task created for work order ${t.number}`)}static \u0275fac=function(e){return new(e||c)(I(w))};static \u0275prov=f({token:c,factory:c.\u0275fac,providedIn:"root"})};export{v as a,R as b};
