import{b as Be,c as Re,d as je}from"./chunk-BVFQVL7G.js";import{b as ze}from"./chunk-UM6B7XYO.js";import"./chunk-NAJWCQTC.js";import{a as H,b as G}from"./chunk-3NY7DZAO.js";import{a as De,b as Fe}from"./chunk-IG52HGJK.js";import{c as J,d as K}from"./chunk-F3IDZWT3.js";import{a as we,b as Me,c as xe}from"./chunk-32YKJWL6.js";import{a as Se,b as ye}from"./chunk-XSZPG6JQ.js";import{a as Pe,b as ke,c as Ie,d as We}from"./chunk-7KHN4GSN.js";import"./chunk-53AZ54VS.js";import{a as ve,c as be,d as Ve,e as Te,k as Ne,m as Oe,n as Ee}from"./chunk-FDJQSJ4V.js";import{d as Le}from"./chunk-WESEQCCP.js";import"./chunk-JHEXQXAK.js";import{a as ie,b as re,c as ce,d as de,e as pe,f as _e,g as ue,h as Ce,i as ge}from"./chunk-H2G74B6L.js";import"./chunk-CESBHL5B.js";import"./chunk-GC2JCOQQ.js";import{a as he,b as fe}from"./chunk-2QDM327Y.js";import{a as q,b as U}from"./chunk-H5EFK6NK.js";import{g as $,h as ee,j as te,k as ne,o as le,p as se,q as me}from"./chunk-Y4SKA4DN.js";import{a as oe,c as ae}from"./chunk-LF3AIU6I.js";import"./chunk-OX3V4ML4.js";import"./chunk-5AAZBCL7.js";import{d as B,e as R}from"./chunk-6RCJUTWS.js";import{d as Q,g as X,j as Y,q as Z}from"./chunk-YLQVLZ7P.js";import"./chunk-CN3ZPC5G.js";import"./chunk-4VDSMCYZ.js";import{Ha as j,Ia as A,j as D,k as F,p as L}from"./chunk-7ENSWGND.js";import{Ac as f,Bc as z,Cc as w,I as E,L as P,Lc as I,Sb as p,Sc as W,Tb as n,Ub as i,Vb as M,Zb as y,_b as v,a as V,ac as x,b as T,bb as l,fc as C,h as O,hc as _,la as c,lb as S,ma as d,rb as k,rc as b,wc as s,xb as g,xc as h,yc as N}from"./chunk-WBOJ7OJP.js";var qe=()=>["/orders"];function Ue(a,o){if(a&1&&(n(0,"nz-tag",31),s(1),i()),a&2){let t=o.$implicit,e=_(2);p("nzColor",e.getTagColor(t)),l(),h(t)}}function He(a,o){a&1&&(n(0,"span"),s(1,"-"),i())}function Ge(a,o){if(a&1){let t=x();n(0,"tr")(1,"td")(2,"label",18),w("ngModelChange",function(r){let m=c(t).$implicit;return z(m.checked,r)||(m.checked=r),d(r)}),C("ngModelChange",function(){c(t);let r=_();return d(r.refreshCheckedStatus())}),i()(),n(3,"td")(4,"a",27),C("click",function(){let r=c(t).$implicit,m=_();return d(m.openProfile(r))}),s(5),i()(),n(6,"td"),s(7),i(),n(8,"td"),s(9),i(),n(10,"td"),s(11),i(),n(12,"td"),g(13,Ue,2,2,"nz-tag",28)(14,He,2,0,"span",29),i(),n(15,"td")(16,"button",30),C("click",function(){let r=c(t).$implicit,m=_();return d(m.openProfile(r))}),s(17,"View"),i(),n(18,"button",30),C("click",function(){let r=c(t).$implicit,m=_();return d(m.createOrderFor(r))}),s(19,"Create Order"),i()()()}if(a&2){let t=o.$implicit,e=_();l(2),f("ngModel",t.checked),l(3),h(t.name),l(2),h(e.formatPhone(t.phone)),l(2),h(t.email||"-"),l(2),h(e.formatRelative(t.lastOrderAt)),l(2),p("ngForOf",t.tags),l(),p("ngIf",!(t.tags!=null&&t.tags.length))}}function Je(a,o){if(a&1){let t=x();n(0,"span"),s(1,"No customers found. "),n(2,"a",27),C("click",function(){c(t);let r=_(2);return d(r.showCreateModal())}),s(3,"Create one?"),i()()}}function Ke(a,o){if(a&1&&(n(0,"div",32)(1,"nz-empty",33),g(2,Je,4,0,"ng-template",null,1,W),i()()),a&2){let t=b(3);l(),p("nzNotFoundContent",t)}}function Qe(a,o){if(a&1){let t=x();n(0,"div",34)(1,"button",35),C("click",function(){c(t);let r=_();return d(r.showMergeModal())}),M(2,"span",36),s(3),i()()}if(a&2){let t=_();l(3),N(" Merge Selected (",t.checkedCount,") ")}}function Xe(a,o){if(a&1&&(n(0,"p",59),s(1),i()),a&2){let t=_(3);l(),h(t.selectedCustomer.email)}}function Ye(a,o){if(a&1&&(n(0,"p",60),s(1),i()),a&2){let t=_(3);l(),N("Unit: ",t.selectedCustomer.unit)}}function Ze(a,o){if(a&1&&(n(0,"nz-tag",31),s(1),i()),a&2){let t=o.$implicit,e=_(3);p("nzColor",e.getTagColor(t)),l(),h(t)}}function $e(a,o){a&1&&(n(0,"span",64),s(1,"(Default)"),i())}function et(a,o){if(a&1&&(n(0,"div",61),M(1,"nz-badge",62),g(2,$e,2,0,"span",63),i()),a&2){let t=o.$implicit,e=o.index;l(),p("nzStatus",e===0?"success":"default")("nzText",t.line1+(t.city?", "+t.city:"")),l(),p("ngIf",e===0)}}function tt(a,o){a&1&&(n(0,"p",65),s(1,"No addresses saved"),i())}function nt(a,o){if(a&1&&(n(0,"tr")(1,"td")(2,"a",66),s(3),i()(),n(4,"td"),s(5),i(),n(6,"td")(7,"nz-tag",31),s(8),i()(),n(9,"td"),s(10),i()()),a&2){let t=o.$implicit,e=_(3);l(2),p("routerLink",I(6,qe)),l(),h(t.number),l(2),h(e.formatDate(t.createdAt)),l(2),p("nzColor",e.getStatusColor(t.status)),l(),h(t.status),l(2),h(t.category)}}function it(a,o){a&1&&(n(0,"p",65),s(1,"No orders yet"),i())}function rt(a,o){if(a&1){let t=x();n(0,"div",38)(1,"div",39)(2,"h3"),s(3),i(),n(4,"p",40),s(5),i(),g(6,Xe,2,1,"p",41)(7,Ye,2,1,"p",42),n(8,"div",43),g(9,Ze,2,2,"nz-tag",28),i()(),M(10,"nz-divider"),n(11,"div",44),M(12,"nz-statistic",45)(13,"nz-statistic",46)(14,"nz-statistic",47),i(),M(15,"nz-divider",48),n(16,"div",49),g(17,et,3,3,"div",50)(18,tt,2,0,"p",51),i(),M(19,"nz-divider",52),n(20,"div",53)(21,"textarea",54),w("ngModelChange",function(r){c(t);let m=_(2);return z(m.editNotes,r)||(m.editNotes=r),d(r)}),i(),n(22,"button",55),C("click",function(){c(t);let r=_(2);return d(r.saveNotes())}),s(23,"Save Notes"),i()(),M(24,"nz-divider",56),n(25,"nz-table",57,2)(27,"thead")(28,"tr")(29,"th"),s(30,"Number"),i(),n(31,"th"),s(32,"Date"),i(),n(33,"th"),s(34,"Status"),i(),n(35,"th"),s(36,"Category"),i()()(),n(37,"tbody"),g(38,nt,11,7,"tr",19),i()(),g(39,it,2,0,"p",51),n(40,"div",58)(41,"button",5),C("click",function(){c(t);let r=_(2);return d(r.createOrderFor(r.selectedCustomer))}),s(42,"Create Order"),i()()()}if(a&2){let t=b(26),e=_(2);l(3),h(e.selectedCustomer.name),l(2),h(e.formatPhone(e.selectedCustomer.phone)),l(),p("ngIf",e.selectedCustomer.email),l(),p("ngIf",e.selectedCustomer.unit),l(2),p("ngForOf",e.selectedCustomer.tags),l(3),p("nzValue",e.customerOrders.length),l(),p("nzValue",e.warrantyCount),l(),p("nzValue",e.completedCount),l(3),p("ngForOf",e.selectedCustomer.addresses),l(),p("ngIf",!(e.selectedCustomer.addresses!=null&&e.selectedCustomer.addresses.length)),l(3),f("ngModel",e.editNotes),l(4),p("nzData",e.customerOrders)("nzPageSize",5),l(13),p("ngForOf",t.data),l(),p("ngIf",e.customerOrders.length===0)}}function ot(a,o){if(a&1&&(y(0),g(1,rt,43,15,"div",37),v()),a&2){let t=_();l(),p("ngIf",t.selectedCustomer)}}function at(a,o){if(a&1){let t=x();y(0),n(1,"nz-form-item")(2,"nz-form-label",67),s(3,"Name"),i(),n(4,"nz-form-control")(5,"input",68),w("ngModelChange",function(r){c(t);let m=_();return z(m.newCustomer.name,r)||(m.newCustomer.name=r),d(r)}),i()()(),n(6,"nz-form-item")(7,"nz-form-label",67),s(8,"Phone"),i(),n(9,"nz-form-control")(10,"input",69),w("ngModelChange",function(r){c(t);let m=_();return z(m.newCustomer.phone,r)||(m.newCustomer.phone=r),d(r)}),i()()(),n(11,"nz-form-item")(12,"nz-form-label"),s(13,"Email"),i(),n(14,"nz-form-control")(15,"input",70),w("ngModelChange",function(r){c(t);let m=_();return z(m.newCustomer.email,r)||(m.newCustomer.email=r),d(r)}),i()()(),n(16,"nz-form-item")(17,"nz-form-label"),s(18,"Unit"),i(),n(19,"nz-form-control")(20,"input",71),w("ngModelChange",function(r){c(t);let m=_();return z(m.newCustomer.unit,r)||(m.newCustomer.unit=r),d(r)}),i()()(),v()}if(a&2){let t=_();l(5),f("ngModel",t.newCustomer.name),l(5),f("ngModel",t.newCustomer.phone),l(5),f("ngModel",t.newCustomer.email),l(5),f("ngModel",t.newCustomer.unit)}}function lt(a,o){if(a&1&&M(0,"nz-option",75),a&2){let t=o.$implicit;p("nzValue",t.id)("nzLabel",t.name+" ("+t.phone+")")}}function st(a,o){if(a&1){let t=x();y(0),n(1,"p"),s(2,"Select which customer to keep as master:"),i(),n(3,"nz-select",72),w("ngModelChange",function(r){c(t);let m=_();return z(m.mergeMasterId,r)||(m.mergeMasterId=r),d(r)}),g(4,lt,1,2,"nz-option",73),i(),n(5,"p",74),s(6," The other customer will be deleted and their orders re-linked to the master. "),i(),v()}if(a&2){let t=_();l(3),f("ngModel",t.mergeMasterId),l(),p("ngForOf",t.selectedForMerge)}}var Ae=class a{constructor(o,t,e,r,m){this.customerService=o;this.stateService=t;this.router=e;this.message=r;this.modal=m}searchPhone="";searchName="";searchEmail="";loading=!1;filteredCustomers=[];allChecked=!1;profileVisible=!1;selectedCustomer=null;customerOrders=[];editNotes="";createModalVisible=!1;newCustomer={name:"",phone:"",email:"",unit:""};mergeModalVisible=!1;mergeMasterId=null;selectedForMerge=[];searchSubject=new O;formatPhone=Re;formatRelative=Be;get checkedCount(){return this.filteredCustomers.filter(o=>o.checked).length}get warrantyCount(){return this.customerOrders.filter(o=>o.warranty).length}get completedCount(){return this.customerOrders.filter(o=>o.status==="Completed").length}ngOnInit(){this.loadCustomers(),this.searchSubject.pipe(E(350),P()).subscribe(()=>this.performSearch())}loadCustomers(){this.filteredCustomers=this.customerService.getAll().map(o=>T(V({},o),{checked:!1}))}onSearchChange(){this.searchSubject.next()}performSearch(){if(!this.searchPhone&&!this.searchName&&!this.searchEmail){this.loadCustomers();return}this.loading=!0,this.customerService.search({phone:this.searchPhone||void 0,name:this.searchName||void 0,email:this.searchEmail||void 0}).subscribe(o=>{this.filteredCustomers=o.map(t=>T(V({},t),{checked:!1})),this.loading=!1})}clearSearch(){this.searchPhone="",this.searchName="",this.searchEmail="",this.loadCustomers()}checkAll(o){this.filteredCustomers.forEach(t=>t.checked=o)}refreshCheckedStatus(){this.allChecked=this.filteredCustomers.every(o=>o.checked)}openProfile(o){this.selectedCustomer=o,this.editNotes=o.notes||"",this.loadCustomerOrders(o.id),this.profileVisible=!0}closeProfile(){this.profileVisible=!1,this.selectedCustomer=null}loadCustomerOrders(o){this.stateService.workOrders$.subscribe(t=>{this.customerOrders=t.filter(e=>e.customerId===o||e.customer?.phone&&this.customerService.getById(o)?.phone===e.customer.phone)})}saveNotes(){this.selectedCustomer&&(this.customerService.update(this.selectedCustomer.id,{notes:this.editNotes}),this.selectedCustomer.notes=this.editNotes,this.message.success("Notes saved"))}createOrderFor(o){this.router.navigate(["/create"],{queryParams:{customerId:o.id}})}showCreateModal(){this.newCustomer={name:"",phone:"",email:"",unit:""},this.createModalVisible=!0}createCustomer(){if(!this.newCustomer.name||!this.newCustomer.phone){this.message.warning("Name and Phone are required");return}this.customerService.create({name:this.newCustomer.name,phone:this.newCustomer.phone,email:this.newCustomer.email||void 0,unit:this.newCustomer.unit||void 0}),this.message.success("Customer created"),this.createModalVisible=!1,this.loadCustomers()}showMergeModal(){if(this.selectedForMerge=this.filteredCustomers.filter(o=>o.checked),this.selectedForMerge.length!==2){this.message.warning("Select exactly 2 customers to merge");return}this.mergeMasterId=this.selectedForMerge[0].id,this.mergeModalVisible=!0}confirmMerge(){if(!this.mergeMasterId)return;let o=this.selectedForMerge.find(t=>t.id!==this.mergeMasterId)?.id;o&&(this.customerService.merge(this.mergeMasterId,o),this.message.success("Customers merged"),this.mergeModalVisible=!1,this.loadCustomers())}getTagColor(o){return{VIP:"gold",Warranty:"blue"}[o]||"default"}getStatusColor(o){return{New:"default",Ready:"gold",Assigned:"geekblue",EnRoute:"cyan",OnSite:"processing",Completed:"green",OnHold:"volcano",Cancelled:"red"}[o]||"default"}formatDate(o){return new Date(o).toLocaleDateString()}static \u0275fac=function(t){return new(t||a)(S(je),S(ze),S(B),S(Le),S(Pe))};static \u0275cmp=k({type:a,selectors:[["app-crm"]],decls:45,vars:17,consts:[["customerTable",""],["emptyTpl",""],["orderTable",""],[1,"crm-container"],[1,"page-header"],["nz-button","","nzType","primary",3,"click"],["nz-icon","","nzType","plus"],[1,"search-card"],[1,"search-row"],["nzPrefixIcon","phone",1,"search-input"],["nz-input","","placeholder","Search by Phone",3,"ngModelChange","ngModel"],["nzPrefixIcon","user",1,"search-input"],["nz-input","","placeholder","Search by Name",3,"ngModelChange","ngModel"],["nzPrefixIcon","mail",1,"search-input"],["nz-input","","placeholder","Search by Email",3,"ngModelChange","ngModel"],["nz-button","","nzType","default",3,"click"],[3,"nzData","nzPageSize","nzLoading","nzShowPagination"],["nzWidth","30px"],["nz-checkbox","",3,"ngModelChange","ngModel"],[4,"ngFor","ngForOf"],["class","empty-state",4,"ngIf"],["class","merge-bar",4,"ngIf"],["nzPlacement","right",3,"nzOnClose","nzClosable","nzVisible","nzTitle","nzWidth"],[4,"nzDrawerContent"],["nzTitle","Create Customer","nzOkText","Create",3,"nzVisibleChange","nzOnCancel","nzOnOk","nzVisible"],[4,"nzModalContent"],["nzTitle","Merge Customers","nzOkText","Merge","nzOkDanger","",3,"nzVisibleChange","nzOnCancel","nzOnOk","nzVisible"],[3,"click"],[3,"nzColor",4,"ngFor","ngForOf"],[4,"ngIf"],["nz-button","","nzType","link","nzSize","small",3,"click"],[3,"nzColor"],[1,"empty-state"],[3,"nzNotFoundContent"],[1,"merge-bar"],["nz-button","","nzType","primary","nzDanger","",3,"click"],["nz-icon","","nzType","merge-cells"],["class","profile-content",4,"ngIf"],[1,"profile-content"],[1,"profile-header"],[1,"phone"],["class","email",4,"ngIf"],["class","unit",4,"ngIf"],[1,"tags"],[1,"stats-row"],["nzTitle","Total Orders",3,"nzValue"],["nzTitle","Warranty",3,"nzValue"],["nzTitle","Completed",3,"nzValue"],["nzText","Addresses"],[1,"addresses"],["class","address-item",4,"ngFor","ngForOf"],["class","no-data",4,"ngIf"],["nzText","Notes"],[1,"notes-section"],["nz-input","","rows","3","placeholder","Add notes...",3,"ngModelChange","ngModel"],["nz-button","","nzSize","small",2,"margin-top","8px",3,"click"],["nzText","Order History"],["nzSize","small",3,"nzData","nzPageSize"],[1,"profile-actions"],[1,"email"],[1,"unit"],[1,"address-item"],[3,"nzStatus","nzText"],["class","default-label",4,"ngIf"],[1,"default-label"],[1,"no-data"],[3,"routerLink"],["nzRequired",""],["nz-input","","placeholder","Customer name",3,"ngModelChange","ngModel"],["nz-input","","placeholder","+201001234567",3,"ngModelChange","ngModel"],["nz-input","","placeholder","email@example.com",3,"ngModelChange","ngModel"],["nz-input","","placeholder","Apt 4B",3,"ngModelChange","ngModel"],[2,"width","100%",3,"ngModelChange","ngModel"],[3,"nzValue","nzLabel",4,"ngFor","ngForOf"],[1,"merge-warning",2,"margin-top","16px","color","#ff4d4f"],[3,"nzValue","nzLabel"]],template:function(t,e){if(t&1){let r=x();n(0,"div",3)(1,"div",4)(2,"h2"),s(3,"Customer CRM"),i(),n(4,"button",5),C("click",function(){return c(r),d(e.showCreateModal())}),M(5,"span",6),s(6," Create Customer "),i()(),n(7,"nz-card",7)(8,"div",8)(9,"nz-input-group",9)(10,"input",10),w("ngModelChange",function(u){return c(r),z(e.searchPhone,u)||(e.searchPhone=u),d(u)}),C("ngModelChange",function(){return c(r),d(e.onSearchChange())}),i()(),n(11,"nz-input-group",11)(12,"input",12),w("ngModelChange",function(u){return c(r),z(e.searchName,u)||(e.searchName=u),d(u)}),C("ngModelChange",function(){return c(r),d(e.onSearchChange())}),i()(),n(13,"nz-input-group",13)(14,"input",14),w("ngModelChange",function(u){return c(r),z(e.searchEmail,u)||(e.searchEmail=u),d(u)}),C("ngModelChange",function(){return c(r),d(e.onSearchChange())}),i()(),n(15,"button",15),C("click",function(){return c(r),d(e.clearSearch())}),s(16,"Clear"),i()()(),n(17,"nz-table",16,0)(19,"thead")(20,"tr")(21,"th",17)(22,"label",18),w("ngModelChange",function(u){return c(r),z(e.allChecked,u)||(e.allChecked=u),d(u)}),C("ngModelChange",function(u){return c(r),d(e.checkAll(u))}),i()(),n(23,"th"),s(24,"Name"),i(),n(25,"th"),s(26,"Phone"),i(),n(27,"th"),s(28,"Email"),i(),n(29,"th"),s(30,"Last Order"),i(),n(31,"th"),s(32,"Tags"),i(),n(33,"th"),s(34,"Actions"),i()()(),n(35,"tbody"),g(36,Ge,20,7,"tr",19),i()(),g(37,Ke,4,1,"div",20)(38,Qe,4,1,"div",21),n(39,"nz-drawer",22),C("nzOnClose",function(){return c(r),d(e.closeProfile())}),g(40,ot,2,1,"ng-container",23),i(),n(41,"nz-modal",24),w("nzVisibleChange",function(u){return c(r),z(e.createModalVisible,u)||(e.createModalVisible=u),d(u)}),C("nzOnCancel",function(){return c(r),d(e.createModalVisible=!1)})("nzOnOk",function(){return c(r),d(e.createCustomer())}),g(42,at,21,4,"ng-container",25),i(),n(43,"nz-modal",26),w("nzVisibleChange",function(u){return c(r),z(e.mergeModalVisible,u)||(e.mergeModalVisible=u),d(u)}),C("nzOnCancel",function(){return c(r),d(e.mergeModalVisible=!1)})("nzOnOk",function(){return c(r),d(e.confirmMerge())}),g(44,st,7,2,"ng-container",25),i()()}if(t&2){let r=b(18);l(10),f("ngModel",e.searchPhone),l(2),f("ngModel",e.searchName),l(2),f("ngModel",e.searchEmail),l(3),p("nzData",e.filteredCustomers)("nzPageSize",10)("nzLoading",e.loading)("nzShowPagination",e.filteredCustomers.length>10),l(5),f("ngModel",e.allChecked),l(14),p("ngForOf",r.data),l(),p("ngIf",e.filteredCustomers.length===0&&!e.loading),l(),p("ngIf",e.checkedCount===2),l(),p("nzClosable",!0)("nzVisible",e.profileVisible)("nzTitle",(e.selectedCustomer==null?null:e.selectedCustomer.name)||"Customer")("nzWidth",520),l(2),f("nzVisible",e.createModalVisible),l(2),f("nzVisible",e.mergeModalVisible)}},dependencies:[L,D,F,Z,Q,X,Y,R,ge,_e,ce,de,Ce,pe,ue,Ee,Ne,Oe,ne,te,$,ee,A,j,fe,he,K,J,ae,oe,xe,Me,we,ye,Se,Fe,De,G,H,We,Ie,ke,me,le,se,Te,U,q,ve,Ve,be,re,ie],styles:[".crm-container[_ngcontent-%COMP%]{padding:0}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.search-card[_ngcontent-%COMP%]{margin-bottom:16px}.search-row[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:center;flex-wrap:wrap}.search-input[_ngcontent-%COMP%]{width:220px}.empty-state[_ngcontent-%COMP%]{padding:48px;text-align:center}.merge-bar[_ngcontent-%COMP%]{position:fixed;bottom:24px;left:50%;transform:translate(-50%);z-index:100}.profile-content[_ngcontent-%COMP%]{padding:0}.profile-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 8px}.profile-header[_ngcontent-%COMP%]   .phone[_ngcontent-%COMP%]{font-size:16px;color:#1890ff;margin:0}.profile-header[_ngcontent-%COMP%]   .email[_ngcontent-%COMP%], .profile-header[_ngcontent-%COMP%]   .unit[_ngcontent-%COMP%]{color:#666;margin:4px 0}.tags[_ngcontent-%COMP%]{margin-top:8px}.stats-row[_ngcontent-%COMP%]{display:flex;gap:32px}.addresses[_ngcontent-%COMP%]   .address-item[_ngcontent-%COMP%]{margin-bottom:8px}.default-label[_ngcontent-%COMP%]{color:#52c41a;font-size:12px;margin-left:8px}.notes-section[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%}.no-data[_ngcontent-%COMP%]{color:#999;font-style:italic}.profile-actions[_ngcontent-%COMP%]{margin-top:24px;display:flex;justify-content:flex-end}"]})};export{Ae as CrmComponent};
