import{a as S}from"./chunk-LAGV6VRJ.js";import{b as v}from"./chunk-UM6B7XYO.js";import{a as g}from"./chunk-NAJWCQTC.js";import{aa as f,ea as n}from"./chunk-WBOJ7OJP.js";var b=class a{constructor(s,t,o){this.configService=s;this.geoService=t;this.stateService=o}tryAssign(s){let t=this.configService.getConfig(),o=[];this.stateService.technicians$.subscribe(e=>o=e).unsubscribe();let p=[];this.stateService.assignments$.subscribe(e=>e.forEach(i=>p.push(i))).unsubscribe();let m=o.filter(e=>{if(!e.active||e.shiftStatus!=="On")return!1;let i=new Date(e.currentGeo.ts).getTime();if((new Date().getTime()-i)/(1e3*60)>t.heartbeatMaxAgeMin)return!1;let r=this.geoService.getDistanceKm(e.currentGeo.lat,e.currentGeo.lng,s.address.lat,s.address.lng),K=e.serviceRadiusKm??t.maxRadiusKm,M=Math.min(e.serviceRadiusKm??t.maxRadiusKm,t.maxRadiusKm);return!(r>M||t.requireSkillMatch&&!e.skills?.includes(s.category))});if(m.length===0)return{success:!1,reason:"No eligible technicians nearby"};let l=m.map(e=>{let i=this.geoService.getDistanceKm(e.currentGeo.lat,e.currentGeo.lng,s.address.lat,s.address.lng),u=0,d=[];return this.stateService.workOrders$.subscribe(r=>d=r).unsubscribe(),u=d.filter(r=>r.assignedTechnicianId===e.id&&["Assigned","EnRoute","OnSite"].includes(r.status)).length,{tech:e,dist:i,workload:u}});l.sort((e,i)=>Math.abs(e.dist-i.dist)>.1?e.dist-i.dist:e.workload!==i.workload?e.workload-i.workload:e.tech.id.localeCompare(i.tech.id));let c=l[0],h=Math.max(2,Math.round(c.dist/t.avgSpeedKmh*60));return{success:!0,technicianId:c.tech.id,distanceKm:c.dist,etaMin:h}}static \u0275fac=function(t){return new(t||a)(n(g),n(S),n(v))};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})};export{b as a};
