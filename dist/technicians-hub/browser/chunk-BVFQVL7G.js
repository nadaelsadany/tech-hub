import{a as u,aa as g,b as l,i as h,u as f}from"./chunk-WBOJ7OJP.js";function o(n,e="+20"){if(!n)return"";let t=n.replace(/[^\d+]/g,"");return t.startsWith("+")?t:t.startsWith("00")?"+"+t.slice(2):t.startsWith("0")?e+t.slice(1):e+t}function c(n,e){let t=o(n),r=o(e);return!t||!r?!1:t===r||t.endsWith(r.slice(-7))||r.endsWith(t.slice(-7))}function p(n,e){return!n||!e?!1:n.toLowerCase().includes(e.toLowerCase())}function x(n){if(!n)return"-";let e=Date.now()-new Date(n).getTime(),t=Math.floor(e/6e4);if(t<1)return"Just now";if(t<60)return`${t}m ago`;let r=Math.floor(t/60);if(r<24)return`${r}h ago`;let s=Math.floor(r/24);return s<30?`${s}d ago`:new Date(n).toLocaleDateString()}function j(n){if(!n)return"";if(n.startsWith("+")){let e=n.slice(1);if(e.length>10)return"+"+e.slice(0,2)+" "+e.slice(2,5)+" "+e.slice(5,8)+" "+e.slice(8)}return n}var A=class n{customersSubject=new h([]);customers$=this.customersSubject.asObservable();constructor(){this.initSeedData()}initSeedData(){let e=new Date().toISOString(),t=[{id:"CUST-001",name:"John Doe",phone:"+201001234567",email:"john.doe@example.com",unit:"Apt 4B",defaultAddress:{line1:"123 Broadway",city:"New York",lat:40.713,lng:-74.005},addresses:[{line1:"123 Broadway",city:"New York",lat:40.713,lng:-74.005},{line1:"456 Park Ave",city:"New York",lat:40.762,lng:-73.973}],tags:["VIP","Warranty"],notes:"Preferred morning appointments",createdAt:"2025-06-15T10:00:00Z",updatedAt:e,lastOrderAt:"2026-01-24T10:00:00Z"},{id:"CUST-002",name:"Jane Smith",phone:"+15551234567",email:"jane.smith@example.com",defaultAddress:{line1:"456 5th Ave",city:"New York",lat:40.7484,lng:-73.9857},addresses:[{line1:"456 5th Ave",city:"New York",lat:40.7484,lng:-73.9857}],createdAt:"2025-08-20T14:30:00Z",updatedAt:e},{id:"CUST-003",name:"Mike Wilson",phone:"+201009876543",email:"mike.w@example.com",unit:"Suite 102",defaultAddress:{line1:"789 Park Ave",city:"New York",lat:40.7614,lng:-73.9776},addresses:[{line1:"789 Park Ave",city:"New York",lat:40.7614,lng:-73.9776},{line1:"111 Madison Ave",city:"New York",lat:40.745,lng:-73.984}],tags:["Warranty"],createdAt:"2025-09-10T09:00:00Z",updatedAt:e,lastOrderAt:"2026-01-20T14:00:00Z"},{id:"CUST-004",name:"Sarah Brown",phone:"+201001234567",email:"sarah.b@example.com",defaultAddress:{line1:"321 Wall St",city:"New York",lat:40.7074,lng:-74.0113},addresses:[{line1:"321 Wall St",city:"New York",lat:40.7074,lng:-74.0113}],createdAt:"2025-11-05T11:00:00Z",updatedAt:e},{id:"CUST-005",name:"David Lee",phone:"+15559876543",email:"david.lee@example.com",unit:"Floor 5",defaultAddress:{line1:"555 Lexington Ave",city:"New York",lat:40.755,lng:-73.973},createdAt:"2025-12-01T16:00:00Z",updatedAt:e}];this.customersSubject.next(t)}search(e){return this.customers$.pipe(f(t=>{let r=t;if(e.phone){let s=o(e.phone);r=r.filter(i=>c(i.phone,s))}return e.name&&(r=r.filter(s=>p(s.name,e.name))),e.email&&(r=r.filter(s=>s.email&&s.email.toLowerCase().includes(e.email.toLowerCase()))),r}))}searchByPhone(e){if(!e||e.length<7)return[];let t=o(e);return this.customersSubject.value.filter(r=>c(r.phone,t))}getById(e){return this.customersSubject.value.find(t=>t.id===e)}create(e){let t=new Date().toISOString(),r=l(u({},e),{id:"CUST-"+Math.random().toString(36).substr(2,6).toUpperCase(),phone:o(e.phone),createdAt:t,updatedAt:t}),s=this.customersSubject.value;return this.customersSubject.next([...s,r]),r}update(e,t){let r=this.customersSubject.value,s=r.findIndex(a=>a.id===e);if(s===-1)return;let i=l(u(u({},r[s]),t),{updatedAt:new Date().toISOString()});return t.phone&&(i.phone=o(t.phone)),r[s]=i,this.customersSubject.next([...r]),i}updateLastOrderAt(e){this.update(e,{lastOrderAt:new Date().toISOString()})}addAddress(e,t){let r=this.getById(e);if(!r)return;let s=r.addresses||[];s.some(a=>Math.abs(a.lat-t.lat)<1e-4&&Math.abs(a.lng-t.lng)<1e-4)||this.update(e,{addresses:[...s,t]})}upsertFromOrderForm(e){let t=this.searchByPhone(e.phone);if(t.length===1){let s=t[0];return this.addAddress(s.id,e.address),{customerId:s.id,customer:s,isNew:!1}}let r=this.create({name:e.name,phone:e.phone,email:e.email,unit:e.unit,defaultAddress:e.address,addresses:[e.address]});return{customerId:r.id,customer:r,isNew:!0}}merge(e,t,r){let s=this.getById(e),i=this.getById(t);if(!s||!i)return;let C=[...s.addresses||[],...i.addresses||[]].filter((d,y,I)=>I.findIndex(m=>Math.abs(m.lat-d.lat)<1e-4&&Math.abs(m.lng-d.lng)<1e-4)===y),S=[...new Set([...s.tags||[],...i.tags||[]])],w=[s.notes,i.notes].filter(Boolean).join(`
---
`),b={name:r?.name||s.name,phone:r?.phone||s.phone,email:r?.email||s.email||i.email,unit:r?.unit||s.unit||i.unit,defaultAddress:s.defaultAddress||i.defaultAddress,addresses:C,tags:S,notes:w,lastOrderAt:s.lastOrderAt||i.lastOrderAt};this.update(e,b);let v=this.customersSubject.value.filter(d=>d.id!==t);return this.customersSubject.next(v),this.getById(e)}getAll(){return this.customersSubject.value}static \u0275fac=function(t){return new(t||n)};static \u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})};export{o as a,x as b,j as c,A as d};
